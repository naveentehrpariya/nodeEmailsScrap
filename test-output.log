🧪 TESTING CHATCONTROLLER.GETACCOUNTCHATS DIRECTLY
============================================================
(node:6091) [MONGOOSE] DeprecationWarning: Mongoose: the `strictQuery` option will be switched back to `false` by default in Mongoose 7. Use `mongoose.set('strictQuery', false);` if you want to prepare for this change. Or use `mongoose.set('strictQuery', true);` to suppress this warning.
(Use `node --trace-deprecation ...` to show where the warning was created)
✅ Connected to database
🔄 Calling ChatController.getAccountChats...
📄 Getting chats from database for: naveendev@crossmilescarrier.com
👥 Found other participant via participants array: dispatch@crossmilescarrier.com - Cross Miles Carrier
🔍 Participant analysis for chat Cross Miles Carrier:
   Other participant: dispatch@crossmilescarrier.com - Cross Miles Carrier
🔍 Calling Google Directory API for user ID 105597362485153931945
✅ Google Directory resolved 105597362485153931945 -> Cross Miles Carrier (cached)
🔍 User resolution for Cross Miles Carrier: {
  resolvedName: 'Cross Miles Carrier',
  storedDisplayName: 'Cross Miles Carrier',
  email: 'dispatch@crossmilescarrier.com',
  hasResolvedName: false,
  hasProperEmail: true,
  hasStoredDisplayName: true,
  shouldShow: true,
  showReason: 'proper_email'
}
✅ Showing chat with reason: proper_email
✅ Showing resolved user: Cross Miles Carrier
✅ DM title from stored data: Cross Miles Carrier
➕ Adding new chat for participant: Cross Miles Carrier
👥 Found other participant via participants array: unknown@crossmilescarrier.com - Test Recipient
🔍 Participant analysis for chat Test Recipient:
   Other participant: unknown@crossmilescarrier.com - Test Recipient
🔍 Calling Google Directory API for user ID unknown_recipient
❌ Google Directory API resolution failed for users/unknown_recipient: Resource Not Found: userKey (cached failure)
🔍 User resolution for Test Recipient: {
  resolvedName: null,
  storedDisplayName: 'Test Recipient',
  email: 'unknown@crossmilescarrier.com',
  hasResolvedName: null,
  hasProperEmail: true,
  hasStoredDisplayName: true,
  shouldShow: true,
  showReason: 'proper_email'
}
✅ Showing chat with reason: proper_email
✅ Showing resolved user: Test Recipient
✅ DM title from stored data: Test Recipient
➕ Adding new chat for participant: Test Recipient
👥 Found other participant via participants array: narender@crossmilescarrier.com - narender
🔍 Participant analysis for chat narender:
   Other participant: narender@crossmilescarrier.com - narender
🔍 User resolution for narender: {
  resolvedName: null,
  storedDisplayName: 'narender',
  email: 'narender@crossmilescarrier.com',
  hasResolvedName: null,
  hasProperEmail: true,
  hasStoredDisplayName: true,
  shouldShow: true,
  showReason: 'proper_email'
}
✅ Showing chat with reason: proper_email
✅ Showing resolved user: narender
✅ DM title from stored data: narender
➕ Adding new chat for participant: narender
👥 Found other participant via participants array: user-115048080534626721571@crossmilescarrier.com - User 11504808
🔍 Participant analysis for chat User 11504808:
   Other participant: user-115048080534626721571@crossmilescarrier.com - User 11504808
🔍 Calling Google Directory API for user ID 115048080534626721571
❌ Google Directory API resolution failed for users/115048080534626721571: Resource Not Found: userKey (cached failure)
🔍 User resolution for user-115048080534626721571: {
  resolvedName: null,
  storedDisplayName: 'User 11504808',
  email: 'user-115048080534626721571@crossmilescarrier.com',
  hasResolvedName: null,
  hasProperEmail: false,
  hasStoredDisplayName: false,
  shouldShow: true,
  showReason: 'email_fallback'
}
✅ Showing chat with reason: email_fallback
✅ Showing resolved user: user-115048080534626721571
✅ DM title from stored data: user-115048080534626721571
➕ Adding new chat for participant: user-115048080534626721571
👥 Found other participant via participants array: user-104329836262309309664@crossmilescarrier.com - User 10432983
🔍 Participant analysis for chat User 10432983:
   Other participant: user-104329836262309309664@crossmilescarrier.com - User 10432983
🔍 Calling Google Directory API for user ID 104329836262309309664
❌ Google Directory API resolution failed for users/104329836262309309664: Resource Not Found: userKey (cached failure)
🔍 User resolution for user-104329836262309309664: {
  resolvedName: null,
  storedDisplayName: 'User 10432983',
  email: 'user-104329836262309309664@crossmilescarrier.com',
  hasResolvedName: null,
  hasProperEmail: false,
  hasStoredDisplayName: false,
  shouldShow: true,
  showReason: 'email_fallback'
}
✅ Showing chat with reason: email_fallback
✅ Showing resolved user: user-104329836262309309664
✅ DM title from stored data: user-104329836262309309664
➕ Adding new chat for participant: user-104329836262309309664
👥 Found other participant via participants array: user-103074035611191657205@crossmilescarrier.com - User 10307403
🔍 Participant analysis for chat User 10307403:
   Other participant: user-103074035611191657205@crossmilescarrier.com - User 10307403
🔍 Calling Google Directory API for user ID 103074035611191657205
❌ Google Directory API resolution failed for users/103074035611191657205: Resource Not Found: userKey (cached failure)
🔍 User resolution for user-103074035611191657205: {
  resolvedName: null,
  storedDisplayName: 'User 10307403',
  email: 'user-103074035611191657205@crossmilescarrier.com',
  hasResolvedName: null,
  hasProperEmail: false,
  hasStoredDisplayName: false,
  shouldShow: true,
  showReason: 'email_fallback'
}
✅ Showing chat with reason: email_fallback
✅ Showing resolved user: user-103074035611191657205
✅ DM title from stored data: user-103074035611191657205
➕ Adding new chat for participant: user-103074035611191657205
📝 Adding deduplicated chat: Cross Miles Carrier
📝 Adding deduplicated chat: Test Recipient
📝 Adding deduplicated chat: narender
📝 Adding deduplicated chat: user-115048080534626721571
📝 Adding deduplicated chat: user-104329836262309309664
📝 Adding deduplicated chat: user-103074035611191657205
📊 Response Status: 200
📋 Total chats returned: 9
🎯 Narender chat found: ✅ YES
   Title: "narender"
   Messages: 3
   Space Type: DIRECT_MESSAGE
🎯 Dispatch chat found: ✅ YES
   Title: "Cross Miles Carrier"
   Messages: 2
   Space Type: DIRECT_MESSAGE

📋 All chats returned:
   1. "TEST GROUPS" (SPACE) - 0 messages
   2. "TEST2" (SPACE) - 0 messages
   3. "CMC" (SPACE) - 5 messages
   4. "Cross Miles Carrier" (DIRECT_MESSAGE) - 2 messages
   5. "Test Recipient" (DIRECT_MESSAGE) - 1 messages
   6. "narender" (DIRECT_MESSAGE) - 3 messages
   7. "user-115048080534626721571" (DIRECT_MESSAGE) - 14 messages
   8. "user-104329836262309309664" (DIRECT_MESSAGE) - 15 messages
   9. "user-103074035611191657205" (DIRECT_MESSAGE) - 1 messages

🎉 SUCCESS: Both target chats are now showing in the API!
✅ The fix is working correctly.
🔌 Disconnected from database
